/****************************************************************************/
/* アナログセンサ基板TypeS テストプログラム                                 */
/*                          2007.12 ジャパンマイコンカーラリー実行委員会    */
/****************************************************************************/

/*======================================*/
/* インクルード                         */
/*======================================*/
#include    <no_float.h>                /* stdioの簡略化 最初に置く*/
#include    <stdio.h>
#include    <machine.h>
#include    "h8_3048.h"

/*======================================*/
/* シンボル定義                         */
/*======================================*/

/*======================================*/
/* プロトタイプ宣言                     */
/*======================================*/
void init( void );
int get_ad2( void );
int get_ad3( void );

/*======================================*/
/* グローバル変数の宣言                 */
/*======================================*/
unsigned long   cnt1;                   /* main内で使用             */

/************************************************************************/
/* メインプログラム                                                     */
/************************************************************************/
void main( void )
{
    int     i;

    /* マイコン機能の初期化 */
    init();                             /* 初期化                   */
    init_sci1( 0x00, 79 );              /* SCI1初期化               */
    set_ccr( 0x00 );                    /* 全体割り込み許可         */

    printf( "Analog Sensor PCB TypeS Test Program Ver1.01\n\n");

    while( 1 ) {
        if( cnt1 >= 200 ) {
            cnt1 = 0;
            printf( "Left=%4d , Right=%4d , "
                    "Digital=%x , Center=%d , Bar=%d\r",
                        get_ad3(), get_ad2(), (~P7DR>>4)&0x0f,
                        !!(~P7DR&0x02), ~P7DR&0x01 );
        }
    }
}

/************************************************************************/
/* H8/3048F-ONE 内蔵周辺機能の初期化                                    */
/************************************************************************/
void init( void )
{
    /* ポートの入出力設定 */
    P1DDR = 0xff;
    P2DDR = 0xff;
    P3DDR = 0xff;
    P4DDR = 0xff;
    P5DDR = 0xff;
    P6DDR = 0xf0;                       /* CPU基板上のDIP SW        */
    P8DDR = 0xff;
    P9DDR = 0xf7;
    PADDR = 0xff;
    PBDDR = 0xff;
    /* ポート７は、入力専用なので入出力設定はありません   */

    /* A/Dの初期設定 */
    AD_CSR = 0x1b;                      /* スキャンモード使用AN0-AN3*/
    AD_CSR |= 0x20;                     /* ADスタート               */

    /* ITU0 1ms毎の割り込み */
    ITU0_TCR = 0x20;
    ITU0_GRA = 24575;
    ITU0_IER = 0x01;
    ITU_STR  = 0x01;
}

/************************************************************************/
/* A/D値読み込み(AN2)                                                   */
/* 引数　 なし                                                          */
/* 戻り値 A/D値 0〜1023                                                 */
/************************************************************************/
int get_ad2( void )
{
    return AD_DRC >> 6;
}

/************************************************************************/
/* A/D値読み込み(AN3)                                                   */
/* 引数　 なし                                                          */
/* 戻り値 A/D値 0〜1023                                                 */
/************************************************************************/
int get_ad3( void )
{
    return AD_DRD >> 6;
}

/************************************************************************/
/* ITU0 割り込み処理                                                    */
/************************************************************************/
#pragma interrupt( interrupt_timer0 )
void interrupt_timer0( void )
{
    ITU0_TSR &= 0xfe;                   /* フラグクリア             */
    cnt1++;
}

/************************************************************************/
/* end of file                                                          */
/************************************************************************/
